#!/usr/bin/env bash
set -euo pipefail

if [ ! -d ~/.m2 ]; then mkdir ~/.m2; fi

okToCreate() {
  if [ ! -e $1 ]; then return; fi
  read -p "Recreate $1? [y/N] "
  if [ "${REPLY,,}" == "y" ]; then return; fi
  echo "Abort"
  return 1
}

if okToCreate ~/.m2/settings-security.xml
then
  while [ -z "${MVN_MASTER_PASSWORD:-}" ]
  do
    read -p "Enter Maven master password: " MVN_MASTER_PASSWORD
  done
cat > ~/.m2/settings-security.xml <<EOF
<!-- Generated by $(basename $0) on $(date) -->
<settingsSecurity><master>$(mvn -emp ${MVN_MASTER_PASSWORD})</master></settingsSecurity>
EOF
fi

if okToCreate ~/.m2/settings.xml
then
  sed \
    -e "s|GENERATED_BY|$(basename $0)|" \
    -e "s|GENERATED_ON|$(date)|" \
    -e "s|HEALTH_APIS_RELEASES_NEXUS_USERNAME|${HEALTH_APIS_RELEASES_NEXUS_USERNAME}|" \
    -e "s|HEALTH_APIS_RELEASES_NEXUS_PASSWORD|$(mvn -ep ${HEALTH_APIS_RELEASES_NEXUS_PASSWORD})|" \
    -e "s|GITHUB_USERNAME|${GITHUB_USERNAME}|" \
    -e "s|GITHUB_TOKEN|$(mvn -ep ${GITHUB_TOKEN})|" \
    $FRESNEL_HOME/etc/settings.xml \
    > ~/.m2/settings.xml
fi
